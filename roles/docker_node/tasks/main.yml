# Version unlocking the packages, if you want to update the docker packages.
- name: install versionlock package
  package:
    name: "yum-plugin-versionlock"
    state: present

- name: Version Unlock Docker packages
  community.general.yum_versionlock:
    state: absent
    name:
    - containerd-io
    - docker-ce
    - docker-ce-cli
  register: lock_status
# If packages were already locked, the unlock/lock will not be a change.
  changed_when: lock_status is not changed

- name: install docker packages
  package:
    name: "{{ item }}"
    state: present
  become: true
  register: docker_install_results
  loop:
    - "{{ docker_ce_cli_package }}"
    - "{{ containerd_io_package }}"
    - "{{ docker_ce_package }}"

- name: flag docker service for restart if any changes to installed packages
  set_fact:
    docker_service_state: restarted
  loop: "{{ docker_install_results.results }}"
  when: item.changed

# this will make use of the docker_service_state value set above
# this will always get run to at least ensure the service is enabled/started, but will
# also restart the service if any chnages to the packages were made
- include_tasks: docker-enable-start-restart.yml

- name: make sure docker is running
  include_tasks: docker-daemon-running.yml

- name: install /etc/docker/daemon.json
  template:
    src: daemon.json
    dest: /etc/docker/daemon.json
  become: true
  register: docker_daemon_json_result

# this could be done via a handler, but since it would only be used once not bothering
- include_tasks: docker-enable-start-restart.yml
  vars:
    docker_service_state: restarted
  when: docker_daemon_json_result.changed

- name: make sure docker is running
  include_tasks: docker-daemon-running.yml

# Version locking the packages, so other package update operations do not interfere
# with docker packages.
- name: Version Lock Docker packages
  community.general.yum_versionlock:
    state: present
    name:
    - containerd-io
    - docker-ce
    - docker-ce-cli
  changed_when: lock_status is changed
